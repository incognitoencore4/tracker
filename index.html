<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Protocol v22: Stable</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        /* --- DYNAMIC THEMING --- */
        :root {
            /* DEFAULT */
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --border-color: #30363d;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --accent-green: #2ea043;
            --accent-blue: #1f6feb;
            --accent-orange: #d29922;
            --accent-red: #da3633;
            --boss-bar-fill: #9e1c1c;
            --safe-stroke: #a371f7;
            --redeemed-color: #ffd700;
        }

        /* ZEN THEME (Lvl 2) */
        [data-theme="zen"] {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --border-color: #334155;
            --text-main: #e2e8f0;
            --accent-green: #10b981;
            --accent-blue: #38bdf8;
            --accent-red: #f43f5e;
            --boss-bar-fill: #0ea5e9;
            --safe-stroke: #2dd4bf;
        }

        /* CYBER THEME (Lvl 5) */
        [data-theme="cyber"] {
            --bg-color: #050505;
            --panel-bg: #121212;
            --border-color: #333;
            --text-main: #fff;
            --accent-green: #39ff14;
            --accent-blue: #00ffff;
            --accent-red: #ff0055;
            --boss-bar-fill: #ff00ff;
            --safe-stroke: #cc00ff;
        }

        /* ROYAL THEME (Lvl 20) */
        [data-theme="royal"] {
            --bg-color: #1a0b0b;
            --panel-bg: #2a1515;
            --border-color: #4a2525;
            --text-main: #ffd700;
            --accent-green: #00ff00;
            --accent-blue: #4169e1;
            --accent-red: #dc143c;
            --boss-bar-fill: #ffd700;
            --safe-stroke: #daa520;
        }

        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden; transition: background 0.5s; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .fade-in { animation: fadeIn 0.4s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI COMPONENTS --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; }
        .login-box { background: var(--panel-bg); padding: 40px; border-radius: 6px; border: 1px solid var(--border-color); width: 90%; max-width: 320px; text-align: center; }
        input[type="password"] { width: 100%; padding: 10px; margin: 20px 0; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); font-size: 16px; outline: none; }
        .btn-main { background-color: var(--accent-green); color: white; border: none; padding: 10px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; }
        
        #app-content { display: none; flex-direction: column; align-items: center; padding-bottom: 80px; width: 100%; }
        .container { width: 94%; max-width: 1200px; margin: 0 auto; position: relative; }

        /* --- SETTINGS --- */
        #settings-btn { position: absolute; top: 10px; right: 0; cursor: pointer; font-size: 1.5rem; opacity: 0.5; transition: 0.3s; }
        #settings-btn:hover { opacity: 1; }
        #theme-menu { position: absolute; top: 40px; right: 0; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; display: none; z-index: 500; min-width: 180px; }
        .theme-opt { padding: 10px 12px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; margin-bottom: 4px; }
        .theme-opt:hover { background: rgba(255,255,255,0.1); }
        .theme-opt.locked { opacity: 0.3; cursor: not-allowed; }

        /* --- BOSS --- */
        .boss-container { width: 100%; margin-top: 40px; margin-bottom: 10px; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; position: relative; overflow: hidden; }
        .boss-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; color: var(--text-main); }
        .boss-name { font-weight: bold; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
        .boss-track { width: 100%; height: 24px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; position: relative; }
        .boss-fill { height: 100%; background: var(--boss-bar-fill); width: 100%; transition: width 1s ease-out; box-shadow: inset 0 -2px 5px rgba(0,0,0,0.3); }
        .dmg-float { position: absolute; color: #ff4444; font-weight: bold; font-size: 1.5rem; animation: floatUp 1.5s ease-out forwards; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }

        /* --- VAULT --- */
        .vault-container { width: 100%; display: flex; justify-content: center; gap: 6px; margin-bottom: 20px; flex-wrap: wrap; }
        .vault-slot { width: 36px; height: 36px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 1.1rem; position: relative; opacity: 0.2; filter: grayscale(100%); transition: 0.3s; }
        .vault-slot.unlocked { opacity: 1; filter: grayscale(0%); border-color: var(--color); box-shadow: 0 0 8px var(--glow); }
        .vault-slot:hover { transform: scale(1.1); z-index: 10; }
        .vault-slot:hover::after { content: attr(data-tooltip); position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); background: var(--panel-bg); border: 1px solid var(--border-color); font-size: 0.75rem; padding: 6px 12px; border-radius: 4px; white-space: nowrap; z-index: 100; color: var(--text-main); box-shadow: 0 4px 12px rgba(0,0,0,0.5); }

        /* --- LOOT --- */
        .loot-section { width: 100%; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .loot-controls { flex: 1; min-width: 200px; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; display: flex; align-items: center; justify-content: space-between; }
        .btn-loot { background: var(--accent-blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; opacity: 1; transition: 0.2s; }
        .btn-loot:disabled { opacity: 0.5; cursor: not-allowed; background: var(--border-color); }
        .inventory-display { flex: 2; min-width: 200px; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; display: flex; align-items: center; gap: 20px; }
        .inv-item { display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; color: var(--text-muted); }
        .inv-icon { font-size: 1.5rem; margin-bottom: 4px; }
        .inv-active { color: var(--accent-orange); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* --- HUD & CHARTS --- */
        #dashboard-header { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .hud-card { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; text-align: center; }
        .hud-value { font-size: 1.8rem; font-weight: 600; color: var(--text-main); margin-top: 8px; }
        .hud-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        .progress-box { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 15px 20px; margin-bottom: 30px; display: flex; flex-direction: column; gap: 8px; }
        .progress-track { width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent-green); width: 0%; transition: width 0.8s ease; }

        .heatmap-container { width: 100%; overflow-x: auto; padding-bottom: 12px; display: block; }
        .heatmap-container::-webkit-scrollbar { height: 6px; }
        .heatmap-container::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .analytics-card { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 20px; height: 300px; display: flex; flex-direction: column; min-width: 0; }
        .chart-wrapper { flex-grow: 1; width: 100%; height: 100%; position: relative; overflow: hidden; }
        .section-title { color: var(--text-main); margin: 30px 0 15px 0; font-size: 1.1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }

        .legend { display: flex; justify-content: center; gap: 15px; padding: 15px; background: var(--panel-bg); border-top: 1px solid var(--border-color); position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; font-size: 0.8rem; color: var(--text-main); }
        .legend-box { width: 12px; height: 12px; margin-right: 8px; border-radius: 2px; }
        .domain, .tick line { stroke: var(--border-color); } .tick text { fill: var(--text-muted); font-size: 10px; }

        /* Loot Overlay */
        #loot-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; justify-content: center; align-items: center; }
        .loot-card { background: var(--panel-bg); border: 2px solid var(--border-color); padding: 40px; border-radius: 12px; text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-width: 90%; width: 400px; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- FIXED TOOLTIP --- */
        #tooltip {
            position: fixed; /* Fixed prevents it from getting stuck in top-left */
            background: var(--panel-bg); border: 1px solid var(--border-color);
            padding: 8px 12px; border-radius: 4px; pointer-events: none; opacity: 0;
            z-index: 9999; font-size: 0.8rem; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transform: translate(10px, 10px); /* Offset from cursor */
        }
    </style>
</head>
<body>

    <div id="tooltip"></div>

    <div id="loot-overlay" onclick="closeLoot()">
        <div class="loot-card" id="loot-card">
            <div style="font-size:0.9rem; text-transform:uppercase; letter-spacing:2px; margin-bottom:10px" id="loot-rarity-text">Legendary</div>
            <div style="font-size: 4rem; margin: 10px 0;" id="loot-icon">üíé</div>
            <div style="font-size: 2rem; margin: 10px 0; color: white;" id="loot-title">Lazarus Token</div>
            <div style="color: var(--text-muted); margin-bottom: 20px;" id="loot-desc">Description</div>
            <button class="btn-loot" onclick="closeLoot()">Claim</button>
        </div>
    </div>

    <div id="login-screen" class="flex-center">
        <div class="login-box fade-in">
            <h2 style="color:white; margin-top:0;">Protocol v21</h2>
            <input type="password" id="password-input" placeholder="Enter Decryption Key">
            <button class="btn-main" onclick="attemptUnlock()">Initialize</button>
            <div id="error-msg" style="color:#ff6666; margin-top:15px; display:none">Invalid Key</div>
        </div>
    </div>

    <div id="app-content">
        <div class="container fade-in">
            
            <div id="settings-btn" onclick="toggleThemeMenu()">‚öôÔ∏è</div>
            <div id="theme-menu">
                <div class="theme-opt" onclick="setTheme('default')">‚ö´ Default (Protocol)</div>
                <div class="theme-opt locked" id="theme-zen" onclick="setTheme('zen')">üîí Zen Mode (Lvl 2)</div>
                <div class="theme-opt locked" id="theme-cyber" onclick="setTheme('cyber')">üîí Cyber Mode (Lvl 5)</div>
                <div class="theme-opt locked" id="theme-royal" onclick="setTheme('royal')">üîí Royal Mode (Lvl 20)</div>
            </div>

            <div class="boss-container">
                <div class="boss-header">
                    <span class="boss-name" id="boss-name">The Entity</span>
                    <span class="boss-stats" id="boss-hp-text">Loading...</span>
                </div>
                <div class="boss-track" id="boss-track">
                    <div class="boss-fill" id="boss-bar"></div>
                </div>
            </div>

            <div class="vault-container" id="vault"></div>

            <div class="loot-section">
                <div class="loot-controls">
                    <div>
                        <div style="font-size:0.8rem; color:var(--text-muted)">Supply Crates</div>
                        <div style="font-size:1.2rem; font-weight:bold; color:var(--text-main)" id="loot-count-display">0</div>
                    </div>
                    <button id="btn-open-loot" class="btn-loot" onclick="openLootBox()" disabled>Open Crate</button>
                </div>
                <div class="inventory-display">
                    <div class="inv-item">
                        <div class="inv-icon">üíé</div>
                        <div id="inv-tokens">x0</div>
                        <div>Tokens</div>
                    </div>
                    <div class="inv-item" id="adrenaline-ui">
                        <div class="inv-icon">‚ö°</div>
                        <div id="inv-adrenaline">Inactive</div>
                        <div>Adrenaline</div>
                    </div>
                </div>
            </div>

            <div id="dashboard-header">
                <div class="hud-card">
                    <div class="hud-label">Current Streak</div>
                    <div class="hud-value" id="hud-streak" style="color: var(--accent-green)">0</div>
                </div>
                <div class="hud-card">
                    <div class="hud-label">Best Streak</div>
                    <div class="hud-value" id="hud-best">0</div>
                </div>
                <div class="hud-card">
                    <div class="hud-label">Relapse Ratio</div>
                    <div class="hud-value" id="hud-ratio" style="color: var(--accent-red)">0%</div>
                </div>
            </div>

            <div class="progress-box">
                <div class="progress-header">
                    <span>Progress to Personal Record</span>
                    <span id="progress-text">0 / 0 Days</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="progress-bar"></div>
                </div>
            </div>

            <div class="section-title">Daily Log</div>
            <div id="years-container" style="width:100%"></div>

            <div class="section-title">Deep Analytics <span id="ai-insight" class="insight-text">...</span></div>
            
            <div class="analytics-grid">
                <div class="analytics-card"><h4>Day Type Distribution</h4><div id="chart-donut" class="chart-wrapper"></div></div>
                <div class="analytics-card"><h4>Danger Zones (Hour)</h4><div id="chart-hourly" class="chart-wrapper"></div></div>
                <div class="analytics-card"><h4>Weekly Patterns</h4><div id="chart-weekday" class="chart-wrapper"></div></div>
                <div class="analytics-card" style="grid-column: 1 / -1;"><h4>Cumulative Impact</h4><div id="chart-cumulative" class="chart-wrapper"></div></div>
            </div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-box" style="background:var(--accent-green)"></div>Clean</div>
        <div class="legend-item"><div class="legend-box" style="background:var(--accent-blue)"></div>Mindful</div>
        <div class="legend-item"><div class="legend-box" style="background:var(--accent-orange)"></div>Visual</div>
        <div class="legend-item"><div class="legend-box" style="background:var(--accent-red)"></div>Relapse</div>
        <div class="legend-item"><div class="legend-box" style="background:var(--redeemed-color)"></div>Saved (Token)</div>
    </div>

    <script>
        // CONFIG
        const ENCRYPTED_URL = "U2FsdGVkX1+rszJFjBAFJPYF14PkiKf03rpTHD7KIxxrtnnEAkk7YaJYJfVpz0wcFuA3aIspysOFNn1VxtKHckzi5tXO7CSTjJu8qlQAvFs0R+Hex4Bi3qcs0Q+wsScpc/tD5sCFw8cmx/tc3JUzd2brkBrQLpRUg/Z4lMfTmSFkBb0dXPWpAOVZDmKeamvM0dld60ylufx1tzyse57OMhOBz7ebabd+QrGR16veiLFgASLn79ICGKmhHoiVbALFhvON+l7Z1mCs/BaDd/mFnQ==";
        const COLORS = { clean: '#2ea043', mindful: '#1f6feb', visual: '#d29922', relapse: '#da3633', empty: '#161b22', text: '#c9d1d9', redeemed: '#ffd700' };
        const DAY_NAMES = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        
        // BOSS MECHANICS
        const BOSS_BASE_HP = 5000;
        const BOSS_HP_SCALE = 1000;
        const DMG = { clean: 100, mindful: 50, relapse: 300 };

        // RELICS (50 Levels)
        const RELICS = [
            // Tier 1: Material (1-5)
            { id: 1, icon: "üõ°Ô∏è", name: "Iron Heart", color: "#8b949e", glow: "rgba(201, 209, 217, 0.4)" },
            { id: 2, icon: "üßò", name: "Zen Stone", color: "#2dd4bf", glow: "rgba(45, 212, 191, 0.6)", desc: "Unlocks Zen Theme" },
            { id: 3, icon: "üó°Ô∏è", name: "Bronze Edge", color: "#cd7f32", glow: "rgba(205, 127, 50, 0.6)", desc: "Passive: Iron Will" },
            { id: 4, icon: "üè∫", name: "Silver Chalice", color: "#c0c0c0", glow: "rgba(192, 192, 192, 0.6)" },
            { id: 5, icon: "ü¶æ", name: "Cyber Core", color: "#ff00ff", glow: "rgba(255, 0, 255, 0.6)", desc: "Unlocks Cyber Theme" },
            // Tier 2: Elemental (6-10)
            { id: 6, icon: "üî•", name: "Ember Spark", color: "#ff4500", glow: "rgba(255, 69, 0, 0.6)" },
            { id: 7, icon: "üåä", name: "Tidal Wave", color: "#00bfff", glow: "rgba(0, 191, 255, 0.6)" },
            { id: 8, icon: "üåø", name: "Gaia Root", color: "#32cd32", glow: "rgba(50, 205, 50, 0.6)" },
            { id: 9, icon: "üå™Ô∏è", name: "Storm Caller", color: "#d3d3d3", glow: "rgba(211, 211, 211, 0.6)" },
            { id: 10, icon: "üî±", name: "The Eternal", color: "#ffffff", glow: "rgba(255, 255, 255, 0.8)", desc: "Passive: Mastery" },
            // Tier 3: Cosmic (11-20)
            { id: 11, icon: "üåô", name: "Moon Walker", color: "#f0f8ff", glow: "rgba(240, 248, 255, 0.6)" },
            { id: 12, icon: "‚òÄÔ∏è", name: "Sun Bringer", color: "#ffa500", glow: "rgba(255, 165, 0, 0.6)" },
            { id: 13, icon: "‚≠ê", name: "Star Dust", color: "#add8e6", glow: "rgba(173, 216, 230, 0.6)" },
            { id: 14, icon: "‚òÑÔ∏è", name: "Comet Shard", color: "#ff6347", glow: "rgba(255, 99, 71, 0.6)" },
            { id: 15, icon: "ü™ê", name: "Ringed World", color: "#f4a460", glow: "rgba(244, 164, 96, 0.6)" },
            { id: 16, icon: "üåå", name: "Galaxy Core", color: "#8a2be2", glow: "rgba(138, 43, 226, 0.6)" },
            { id: 17, icon: "‚ö´", name: "Black Hole", color: "#696969", glow: "rgba(105, 105, 105, 0.6)" },
            { id: 18, icon: "‚ú®", name: "Quasar Light", color: "#e0ffff", glow: "rgba(224, 255, 255, 0.6)" },
            { id: 19, icon: "üß¨", name: "Life Seed", color: "#98fb98", glow: "rgba(152, 251, 152, 0.6)" },
            { id: 20, icon: "üëë", name: "Royal Scepter", color: "#ffd700", glow: "rgba(255, 215, 0, 0.8)", desc: "Unlocks Royal Theme" },
            // Tier 4: Mythical (21-30)
            { id: 21, icon: "ü¶Ö", name: "Griffin Claw", color: "#8b4513", glow: "rgba(139, 69, 19, 0.6)" },
            { id: 22, icon: "üßú", name: "Siren Song", color: "#40e0d0", glow: "rgba(64, 224, 208, 0.6)" },
            { id: 23, icon: "üêç", name: "Hydra Scale", color: "#228b22", glow: "rgba(34, 139, 34, 0.6)" },
            { id: 24, icon: "ü¶Ñ", name: "Pure Horn", color: "#ffb6c1", glow: "rgba(255, 182, 193, 0.6)" },
            { id: 25, icon: "üê≤", name: "Dragon Spirit", color: "#dc143c", glow: "rgba(220, 20, 60, 0.6)" },
            { id: 26, icon: "üëª", name: "Phantom Veil", color: "#f8f8ff", glow: "rgba(248, 248, 255, 0.6)" },
            { id: 27, icon: "üíÄ", name: "Lich Crown", color: "#4b0082", glow: "rgba(75, 0, 130, 0.6)" },
            { id: 28, icon: "üëº", name: "Seraph Wing", color: "#fffacd", glow: "rgba(255, 250, 205, 0.6)" },
            { id: 29, icon: "üßû", name: "Djinn Lamp", color: "#800080", glow: "rgba(128, 0, 128, 0.6)" },
            { id: 30, icon: "üåã", name: "Titan Magma", color: "#ff8c00", glow: "rgba(255, 140, 0, 0.6)" },
            // Tier 5: Quantum (31-40)
            { id: 31, icon: "‚ò¢Ô∏è", name: "Isotope 235", color: "#7fff00", glow: "rgba(127, 255, 0, 0.6)" },
            { id: 32, icon: "üîÆ", name: "Dark Matter", color: "#191970", glow: "rgba(25, 25, 112, 0.6)" },
            { id: 33, icon: "üß™", name: "Antimatter Vial", color: "#ff00ff", glow: "rgba(255, 0, 255, 0.6)" },
            { id: 34, icon: "üî≠", name: "Event Horizon", color: "#000000", glow: "rgba(255, 255, 255, 0.4)" },
            { id: 35, icon: "üìê", name: "Hypercube", color: "#00ced1", glow: "rgba(0, 206, 209, 0.6)" },
            { id: 36, icon: "ü§ñ", name: "AI Singularity", color: "#00ff7f", glow: "rgba(0, 255, 127, 0.6)" },
            { id: 37, icon: "‚öôÔ∏è", name: "Nano Swarm", color: "#c0c0c0", glow: "rgba(192, 192, 192, 0.6)" },
            { id: 38, icon: "üíæ", name: "Source Code", color: "#32cd32", glow: "rgba(50, 205, 50, 0.6)" },
            { id: 39, icon: "üõ∞Ô∏è", name: "Dyson Sphere", color: "#b8860b", glow: "rgba(184, 134, 11, 0.6)" },
            { id: 40, icon: "‚öõÔ∏è", name: "Quantum Field", color: "#00ffff", glow: "rgba(0, 255, 255, 0.6)" },
            // Tier 6: Divinity (41-50)
            { id: 41, icon: "üëÅÔ∏è", name: "Omni Eye", color: "#ff69b4", glow: "rgba(255, 105, 180, 0.6)" },
            { id: 42, icon: "üóùÔ∏è", name: "Reality Key", color: "#ff1493", glow: "rgba(255, 20, 147, 0.6)" },
            { id: 43, icon: "‚öñÔ∏è", name: "Fate Balance", color: "#d2b48c", glow: "rgba(210, 180, 140, 0.6)" },
            { id: 44, icon: "‚è≥", name: "Time Keeper", color: "#cd853f", glow: "rgba(205, 133, 63, 0.6)" },
            { id: 45, icon: "‚ôæÔ∏è", name: "Infinity Loop", color: "#8a2be2", glow: "rgba(138, 43, 226, 0.6)" },
            { id: 46, icon: "‚ú®", name: "Pure Light", color: "#ffffff", glow: "rgba(255, 255, 255, 0.9)" },
            { id: 47, icon: "üåë", name: "Absolute Void", color: "#000000", glow: "rgba(100, 100, 100, 0.9)" },
            { id: 48, icon: "üåÄ", name: "Chaos Theory", color: "#ff4500", glow: "rgba(255, 69, 0, 0.8)" },
            { id: 49, icon: "üí†", name: "Nirvana Lotus", color: "#ffc0cb", glow: "rgba(255, 192, 203, 0.8)" },
            { id: 50, icon: "üåå", name: "The Beginning", color: "#fffafa", glow: "rgba(255, 250, 250, 1.0)", desc: "Ultimate Victory" }
        ];

        // STATE
        let GLOBAL_DATA = null;
        let CURRENT_BOSS_LEVEL = 1; // Global Level Tracker
        let resizeObserver = null;
        
        let GAME_STATE = {
            lootBoxes: 0,
            inventory: { tokens: 0 },
            activeAdrenalineDate: null, 
            redeemedDates: [],
            bonusDamage: 0,
            lifetimeLootGenerated: 0,
            currentTheme: 'default'
        };

        function attemptUnlock() {
            const pass = document.getElementById('password-input').value;
            try {
                const bytes = CryptoJS.AES.decrypt(ENCRYPTED_URL, pass);
                const url = bytes.toString(CryptoJS.enc.Utf8);
                if (url.startsWith("http")) {
                    localStorage.setItem('tracker_pass', pass);
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-content').style.display = 'flex';
                    init(url);
                } else throw new Error();
            } catch (e) { document.getElementById('error-msg').style.display = 'block'; }
        }

        window.onload = () => {
            // Update Title to match version
            document.querySelector('#login-screen h2').innerText = "Protocol v22";

            const saved = localStorage.getItem('tracker_pass');
            if(saved) document.getElementById('password-input').value = saved;
            
            const savedState = localStorage.getItem('game_state_v18');
            if(savedState) GAME_STATE = JSON.parse(savedState);
            if(typeof GAME_STATE.lifetimeLootGenerated === 'undefined') GAME_STATE.lifetimeLootGenerated = 0;
            
            applyTheme(GAME_STATE.currentTheme);
            updateInventoryUI();
        }

        function saveGameState() {
            localStorage.setItem('game_state_v18', JSON.stringify(GAME_STATE));
            updateInventoryUI();
        }

        async function init(url) {
            try {
                const data = await d3.csv(url);
                if (!data) throw new Error("Data load failed");
                GLOBAL_DATA = processData(data);
                generateLootBoxes(GLOBAL_DATA);
                updateHUD(GLOBAL_DATA);
                updateBoss(GLOBAL_DATA);
                renderAllCharts();
                setupResizeObserver();
            } catch (e) {
                console.error("Init Error:", e);
                document.getElementById('error-msg').innerText = "Data Error";
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        function generateLootBoxes(data) {
            const dist = data.distribution;
            const totalGood = dist.clean + dist.mindful;
            if (totalGood > GAME_STATE.lifetimeLootGenerated) {
                GAME_STATE.lootBoxes += (totalGood - GAME_STATE.lifetimeLootGenerated);
                GAME_STATE.lifetimeLootGenerated = totalGood;
                saveGameState();
            }
            updateInventoryUI();
        }

        function openLootBox() {
            if(GAME_STATE.lootBoxes <= 0) return;
            GAME_STATE.lootBoxes--;
            
            const rand = Math.random() * 100;
            let title, desc, icon, rarity, cssVar, dmg = 0;

            if (rand < 60) {
                rarity = "Common"; cssVar = "var(--rarity-common)"; icon = "üì¶";
                title = "Supply Pack"; desc = "Instant 100 Damage"; dmg = 100;
            } else if (rand < 90) {
                rarity = "Rare"; cssVar = "var(--rarity-rare)"; icon = "üí£";
                title = "Heavy Ammo"; desc = "Instant 500 Damage"; dmg = 500;
            } else if (rand < 99) {
                rarity = "Epic"; cssVar = "var(--rarity-epic)"; icon = "‚ö°";
                title = "Adrenaline Shot"; desc = "Next 10 Clean Days deal x2, x3... x10 Damage!";
                GAME_STATE.activeAdrenalineDate = new Date().toISOString(); 
            } else {
                rarity = "Legendary"; cssVar = "var(--rarity-legendary)"; icon = "üíé";
                title = "Lazarus Token"; desc = "Saves your streak on next relapse.";
                GAME_STATE.inventory.tokens++;
            }

            if(dmg > 0) {
                GAME_STATE.bonusDamage += dmg;
                showDamageFloat(dmg);
            }
            saveGameState();
            
            document.getElementById('loot-rarity-text').innerText = rarity;
            document.getElementById('loot-rarity-text').style.color = cssVar;
            document.getElementById('loot-icon').innerText = icon;
            document.getElementById('loot-title').innerText = title;
            document.getElementById('loot-desc').innerText = desc;
            document.getElementById('loot-card').style.borderColor = cssVar;
            document.getElementById('loot-overlay').style.display = 'flex';
            
            // Dynamic Update (No Reload)
            if(GLOBAL_DATA) {
                // Mimic reprocessing damage without full re-parse
                GLOBAL_DATA = processData(GLOBAL_DATA.rawData || GLOBAL_DATA);
                updateBoss(GLOBAL_DATA);
                updateInventoryUI();
            }
        }
        
        function showDamageFloat(amt) {
            const el = document.createElement('div'); el.className = 'dmg-float'; el.innerText = `-${amt}`;
            el.style.left = '50%'; el.style.top = '0'; document.getElementById('boss-track').appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        function closeLoot() { document.getElementById('loot-overlay').style.display = 'none'; }

        function updateInventoryUI() {
            document.getElementById('loot-count-display').innerText = GAME_STATE.lootBoxes;
            document.getElementById('btn-open-loot').disabled = (GAME_STATE.lootBoxes === 0);
            document.getElementById('inv-tokens').innerText = "x" + GAME_STATE.inventory.tokens;
            
            const adrEl = document.getElementById('inv-adrenaline');
            if (GAME_STATE.activeAdrenalineDate) {
                adrEl.innerText = "ACTIVE"; adrEl.classList.add('inv-active');
            } else {
                adrEl.innerText = "Inactive"; adrEl.classList.remove('inv-active');
            }
        }

        function renderVault(level) {
            const v = document.getElementById('vault'); v.innerHTML = "";
            RELICS.forEach(r => {
                const u = level > r.id;
                const d = document.createElement('div'); d.className = `vault-slot ${u?'unlocked':''}`; d.innerHTML = r.icon;
                if(u) { d.style.setProperty('--color',r.color); d.style.setProperty('--glow',r.glow); d.setAttribute('data-tooltip', r.name + (r.desc?` (${r.desc})`:'')); }
                else { d.setAttribute('data-tooltip', `Defeat Level ${r.id}`); }
                v.appendChild(d);
            });
        }

        function toggleThemeMenu() { const m = document.getElementById('theme-menu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
        
        function setTheme(theme) {
            const level = CURRENT_BOSS_LEVEL; // Use Global, not DOM scrape
            if (theme === 'zen' && level < 2) return;
            if (theme === 'cyber' && level < 5) return;
            if (theme === 'royal' && level < 20) return;
            applyTheme(theme); GAME_STATE.currentTheme = theme; saveGameState(); document.getElementById('theme-menu').style.display = 'none';
        }
        
        function applyTheme(theme) {
            document.body.removeAttribute('data-theme');
            if(theme !== 'default') document.body.setAttribute('data-theme', theme);
        }

        function processData(data) {
            const map = new Map();
            const hourlyCounts = new Array(24).fill(0);
            const weekdayCounts = { relapse: new Array(7).fill(0), mindful: new Array(7).fill(0) };
            const distribution = { clean: 0, mindful: 0, visual: 0, relapse: 0 };
            const cumulative = [];
            
            let firstLogDate = null;
            const parseDate = d3.timeParse("%m/%d/%Y %H:%M:%S");
            const parseShort = d3.timeParse("%m/%d/%Y");
            const formatIso = d3.timeFormat("%Y-%m-%d");

            if(Array.isArray(data)) {
                data.sort((a,b) => {
                    const dA = parseDate(a['Timestamp']) || parseShort(a['Timestamp']);
                    const dB = parseDate(b['Timestamp']) || parseShort(b['Timestamp']);
                    return dA - dB;
                });
                
                data.forEach(row => {
                    const rawTime = row['Timestamp'];
                    const catRaw = row['Column 1'];
                    if (!rawTime) return;
                    let dateObj = parseDate(rawTime) || parseShort(rawTime);
                    if (dateObj) {
                        const dateKey = formatIso(dateObj);
                        if (!firstLogDate) firstLogDate = dateObj;
                        if (!map.has(dateKey)) map.set(dateKey, { relapseCount: 0, visual: false, mindful: false, redeemed: false });
                        const entry = map.get(dateKey);

                        if (catRaw.includes('Relapse')) {
                            if(GAME_STATE.redeemedDates.includes(dateKey)) {
                                entry.redeemed = true;
                            } else if(GAME_STATE.inventory.tokens > 0) {
                                GAME_STATE.inventory.tokens--;
                                GAME_STATE.redeemedDates.push(dateKey);
                                entry.redeemed = true;
                                saveGameState();
                            } else {
                                if(GAME_STATE.activeAdrenalineDate) {
                                    GAME_STATE.activeAdrenalineDate = null;
                                    saveGameState();
                                }
                                entry.relapseCount++;
                                hourlyCounts[dateObj.getHours()]++;
                                weekdayCounts.relapse[dateObj.getDay()]++;
                            }
                        } else if (catRaw.includes('Visual')) {
                            entry.visual = true;
                        } else if (catRaw.includes('Mindful')) {
                            entry.mindful = true;
                            weekdayCounts.mindful[dateObj.getDay()]++;
                        }
                    }
                });
            }

            const now = new Date();
            let totalBossDamage = 0;
            let totalDays = 0;
            let curRisk = 0;
            let curMind = 0;
            
            let adrenalineActive = false;
            let adrenalineCounter = 0;
            if (GAME_STATE.activeAdrenalineDate) {
                const start = new Date(GAME_STATE.activeAdrenalineDate);
                const diffDays = Math.floor((now - start) / (1000 * 60 * 60 * 24));
                if(diffDays > 10) {
                    GAME_STATE.activeAdrenalineDate = null;
                    saveGameState();
                } else {
                    adrenalineActive = true;
                }
            }

            if(firstLogDate) {
                for (let d = new Date(firstLogDate); d <= now; d.setDate(d.getDate() + 1)) {
                    totalDays++;
                    const key = formatIso(d);
                    const entry = map.get(key);
                    let type = 'clean';
                    let dayDamage = DMG.clean;
                    let rInc = 0; let mInc = 0;

                    if (entry) {
                        if (entry.redeemed) { type = 'clean'; }
                        else if (entry.relapseCount > 0) { type = 'relapse'; dayDamage = -DMG.relapse; rInc=1; } 
                        else if (entry.visual) { type = 'visual'; dayDamage = 0; rInc=1; }
                        else if (entry.mindful) { type = 'mindful'; dayDamage = DMG.mindful; mInc=1; }
                    }

                    if (adrenalineActive && GAME_STATE.activeAdrenalineDate) {
                        const start = new Date(GAME_STATE.activeAdrenalineDate);
                        if (d >= start && (type === 'clean' || type === 'mindful')) {
                            adrenalineCounter++;
                            if (adrenalineCounter <= 10) {
                                dayDamage = dayDamage * adrenalineCounter;
                            }
                        }
                    }

                    distribution[type]++;
                    totalBossDamage += dayDamage;
                    curRisk += rInc;
                    curMind += mInc;
                    cumulative.push({ date: new Date(d), risk: curRisk, mindful: curMind });
                }
            }

            return { map, startLogDate: firstLogDate, hourlyCounts, weekdayCounts, cumulative, distribution, totalDays, totalBossDamage, rawData: Array.isArray(data) ? data : [] };
        }

        function updateBoss(data) {
            let bossLevel = 1;
            let damagePointer = data.totalBossDamage + GAME_STATE.bonusDamage;
            if (damagePointer < 0) damagePointer = 0;

            let currentMaxHP = BOSS_BASE_HP;
            while(damagePointer >= currentMaxHP) {
                damagePointer -= currentMaxHP;
                bossLevel++;
                currentMaxHP = BOSS_BASE_HP + ((bossLevel - 1) * BOSS_HP_SCALE);
            }
            
            // UPDATE GLOBAL TRACKER
            CURRENT_BOSS_LEVEL = bossLevel;

            const currentHP = currentMaxHP - damagePointer;
            const hpPercent = (currentHP / currentMaxHP) * 100;

            const names = ["The Shadow", "The Beast", "The Demon", "The Titan", "The Leviathan", "The Eternal", "The Void", "The Abyss", "The Omega"];
            const bossName = (bossLevel <= names.length) ? names[bossLevel-1] : `Entity Level ${bossLevel}`;

            document.getElementById('boss-name').innerText = `${bossName} (Lvl ${bossLevel})`;
            document.getElementById('boss-hp-text').innerText = `${Math.floor(currentHP).toLocaleString()} / ${currentMaxHP.toLocaleString()} HP`;
            document.getElementById('boss-bar').style.width = hpPercent + "%";
            document.getElementById('boss-bar').style.background = hpPercent < 20 ? "#e62e2e" : "var(--boss-bar-fill)";

            if (bossLevel >= 2) document.getElementById('theme-zen').classList.remove('locked');
            if (bossLevel >= 5) document.getElementById('theme-cyber').classList.remove('locked');
            if (bossLevel >= 20) document.getElementById('theme-royal').classList.remove('locked');

            renderVault(bossLevel);
        }

        function updateHUD(data) {
            const map = data.map; const now = new Date(); const iso = d3.timeFormat("%Y-%m-%d");
            let streak = 0, best = 0, temp = 0;
            if(data.startLogDate) {
                for (let d = new Date(data.startLogDate); d <= now; d.setDate(d.getDate() + 1)) {
                    const e = map.get(iso(d));
                    if (e && e.relapseCount > 0 && !e.redeemed) { if(temp>best)best=temp; temp=0; } else { temp++; }
                }
            }
            streak = temp; if(streak>best)best=streak;
            document.getElementById('hud-streak').innerText = streak;
            document.getElementById('hud-best').innerText = best;
            const r = data.totalDays ? ((data.distribution.relapse/data.totalDays)*100).toFixed(1) : "0.0";
            document.getElementById('hud-ratio').innerText = r+"%";
            document.getElementById('progress-bar').style.width = Math.min((streak/best)*100, 100)+"%";
            document.getElementById('progress-text').innerText = `${streak} / ${best} Days`;
        }
        function renderAllCharts() {
            if(!GLOBAL_DATA) return;
            const d=GLOBAL_DATA;
            renderHeatmaps(d); renderDonutChart(d.distribution); renderHourlyChart(d.hourlyCounts); renderWeekdayChart(d.weekdayCounts); renderCumulativeChart(d.cumulative);
        }
        function renderHeatmaps(d) {
            const c = document.getElementById('years-container'); c.innerHTML = "";
            const y1 = new Date().getFullYear(); const y2 = d.startLogDate?d.startLogDate.getFullYear():y1;
            for(let y=y1; y>=y2; y--) {
                const w = document.createElement('div'); w.className='year-block'; w.innerHTML=`<h5 style="color:var(--text-muted);margin:0 0 5px 10px">${y}</h5><div id="chart-${y}" class="heatmap-container"></div>`;
                c.appendChild(w); drawYear(y, d.map, d.startLogDate);
            }
        }
        function drawYear(y, map, start) {
            const el=document.getElementById(`chart-${y}`); const d1=new Date(y,0,1); const d2=new Date(y,11,31); const days=d3.timeDays(d1,d2);
            const cs=12; const gap=3; const w=53*(cs+gap)+20; const h=7*(cs+gap)+10;
            const svg=d3.select(el).append("svg").attr("width",w).attr("height",h); const g=svg.append("g").attr("transform","translate(10,0)");
            const iso=d3.timeFormat("%Y-%m-%d");
            g.selectAll("rect").data(days).enter().append("rect").attr("width",cs).attr("height",cs)
                .attr("x",d=>d3.timeWeek.count(d3.timeYear(d),d)*(cs+gap)).attr("y",d=>d.getDay()*(cs+gap)).attr("rx",2)
                .attr("fill",d=>{
                    const k=iso(d); const e=map.get(k); if(e&&e.redeemed)return COLORS.redeemed; if(d>new Date())return COLORS.panel;
                    if(!e)return (start&&d<start)?COLORS.empty:COLORS.clean; 
                    if(e.relapseCount>0)return COLORS.relapse; if(e.visual)return COLORS.visual; if(e.mindful)return COLORS.mindful; return COLORS.clean;
                })
                .attr("stroke",d=>{const e=map.get(iso(d)); return (e&&e.redeemed)?COLORS.redeemed:"none";}).attr("stroke-width",d=>{const e=map.get(iso(d)); return (e&&e.redeemed)?2:0;})
                .on("mouseover",(e,d)=>showTooltip(e,d,map));
            g.selectAll("text").data(days).enter().append("text").attr("x",d=>d3.timeWeek.count(d3.timeYear(d),d)*(cs+gap)+cs/2).attr("y",d=>d.getDay()*(cs+gap)+cs/2+1).attr("text-anchor","middle").attr("dominant-baseline","middle").style("font-size","8px").style("fill","white").style("pointer-events","none").text(d=>{const e=map.get(iso(d)); if(e&&e.redeemed)return"‚òÖ"; return (e&&e.relapseCount>1)?e.relapseCount:"";});
            if(y===new Date().getFullYear()) setTimeout(()=>el.scrollLeft=w,250);
        }
        
        // RESPONSIVE CHART HELPERS
        function getDim(el) { return { w: el.getBoundingClientRect().width, h: el.getBoundingClientRect().height }; }
        function setupSVG(el, w, h) {
            return d3.select(el).append("svg")
                .attr("viewBox", `0 0 ${w} ${h}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .style("width", "100%").style("height", "100%");
        }

        // --- ADDED RESIZE OBSERVER LOGIC ---
        function setupResizeObserver() {
            if(!window.ResizeObserver) return;
            resizeObserver = new ResizeObserver(entries => {
                // Avoid rapid firing
                if(window.resizeTimeout) clearTimeout(window.resizeTimeout);
                window.resizeTimeout = setTimeout(() => {
                    if(GLOBAL_DATA) renderAllCharts();
                }, 200);
            });
            const container = document.querySelector('.container');
            if(container) resizeObserver.observe(container);
        }

        function renderDonutChart(dist){
            const el=document.getElementById('chart-donut'); el.innerHTML=""; 
            const {w,h} = getDim(el); const r=Math.min(w,h)/2-10; 
            const svg=setupSVG(el,w,h).append("g").attr("transform",`translate(${w/2},${h/2})`); 
            const d=[{v:dist.clean,c:COLORS.clean},{v:dist.mindful,c:COLORS.mindful},{v:dist.visual,c:COLORS.visual},{v:dist.relapse,c:COLORS.relapse}].filter(x=>x.v>0); 
            const pie=d3.pie().value(x=>x.v); const arc=d3.arc().innerRadius(r*0.55).outerRadius(r); 
            svg.selectAll('path').data(pie(d)).enter().append('path').attr('d',arc).attr('fill',x=>x.data.c).attr('stroke','#161b22').attr('stroke-width',2); 
            svg.append("text").text(d3.sum(d,x=>x.v)).attr("text-anchor","middle").attr("dy","0.3em").style("fill","#fff").style("font-size","1.5rem").style("font-weight","bold");
        }
        function renderHourlyChart(d){
            const el=document.getElementById('chart-hourly'); el.innerHTML=""; 
            const {w,h} = getDim(el); const svg=setupSVG(el,w,h); 
            const x=d3.scaleLinear().domain([0,23]).range([25,w-10]); const y=d3.scaleLinear().domain([0,d3.max(d)||1]).range([h-20,10]); 
            svg.selectAll("rect").data(d).enter().append("rect").attr("x",(v,i)=>x(i)-w/60).attr("y",v=>y(v)).attr("width",w/40).attr("height",v=>h-20-y(v)).attr("fill",COLORS.relapse).attr("rx",1); 
            svg.append("g").attr("transform",`translate(0,${h-20})`).call(d3.axisBottom(x).ticks(6).tickFormat(n=>n+"h")).select(".domain").remove();
        }
        function renderWeekdayChart(d){
            const el=document.getElementById('chart-weekday'); el.innerHTML=""; 
            const {w,h} = getDim(el); const svg=setupSVG(el,w,h); 
            const x=d3.scaleBand().domain(d3.range(7)).range([25,w-10]).padding(0.3); const y=d3.scaleLinear().domain([0,Math.max(d3.max(d.relapse),d3.max(d.mindful))||1]).range([h-20,10]); 
            svg.selectAll(".r").data(d.relapse).enter().append("rect").attr("x",(v,i)=>x(i)).attr("y",v=>y(v)).attr("width",x.bandwidth()/2).attr("height",v=>h-20-y(v)).attr("fill",COLORS.relapse); 
            svg.selectAll(".m").data(d.mindful).enter().append("rect").attr("x",(v,i)=>x(i)+x.bandwidth()/2).attr("y",v=>y(v)).attr("width",x.bandwidth()/2).attr("height",v=>h-20-y(v)).attr("fill",COLORS.mindful); 
            svg.append("g").attr("transform",`translate(0,${h-20})`).call(d3.axisBottom(x).tickFormat(i=>DAY_NAMES[i])).select(".domain").remove();
        }
        function renderCumulativeChart(d){
            const el=document.getElementById('chart-cumulative'); el.innerHTML=""; if(d.length==0)return; 
            const {w,h} = getDim(el); const svg=setupSVG(el,w,h); 
            const x=d3.scaleTime().domain(d3.extent(d,i=>i.date)).range([30,w-10]); 
            const y=d3.scaleLinear().domain([0,d3.max(d,i=>Math.max(i.risk,i.mindful))]).range([h-20,10]); 
            svg.append("path").datum(d).attr("fill","none").attr("stroke",COLORS.relapse).attr("stroke-width",2).attr("d",d3.line().x(i=>x(i.date)).y(i=>y(i.risk))); 
            svg.append("path").datum(d).attr("fill","none").attr("stroke",COLORS.mindful).attr("stroke-width",2).attr("stroke-dasharray","4,2").attr("d",d3.line().x(i=>x(i.date)).y(i=>y(i.mindful))); 
            svg.append("g").attr("transform",`translate(0,${h-20})`).call(d3.axisBottom(x).ticks(5)).select(".domain").remove();
        }
        
        function showTooltip(e,d,map){
            const k=d3.timeFormat("%Y-%m-%d")(d); const entry=map.get(k); let t="Clean",c=COLORS.clean; 
            if(entry){if(entry.redeemed){t="Saved (Token)";c=COLORS.redeemed;}else if(entry.relapseCount>0){t=`Relapse (${entry.relapseCount})`;c=COLORS.relapse;}else if(entry.visual){t="Visual Slip";c=COLORS.visual;}else if(entry.mindful){t="Mindful";c=COLORS.mindful;}} else if(d>new Date()){t="";} 
            if(t){
                const tt=document.getElementById('tooltip'); tt.style.opacity=1; 
                // Fix for positioning
                const [mx, my] = d3.pointer(e, document.body);
                tt.style.left=(mx+15)+'px'; tt.style.top=(my+15)+'px'; 
                tt.innerHTML=`<div style="font-weight:bold;color:${c}">${t}</div><div style="color:#888">${d3.timeFormat("%b %d")(d)}</div>`;
            }
        }
    </script>
</body>
</html>
