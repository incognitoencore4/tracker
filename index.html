<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure Protocol</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* --- GLOBAL STYLES --- */
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            overflow-x: hidden; 
        }

        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #0d1117; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: #161b22; padding: 30px; border-radius: 12px; border: 1px solid #30363d; text-align: center; width: 80%; max-width: 300px; }
        input[type="password"] { width: 90%; padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #30363d; background: #0d1117; color: white; font-size: 16px; }
        button { background-color: #238636; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 16px; cursor: pointer; width: 100%; }
        .error-msg { color: #ff6666; margin-top: 10px; font-size: 14px; display: none; }

        /* --- MAIN APP LAYOUT --- */
        #app-content { 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            width: 100%;
            padding-bottom: 60px; /* Space for sticky legend */
        }

        /* --- YEAR CONTAINER --- */
        .year-block {
            width: 100%;
            margin-bottom: 30px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }

        h1 { font-size: 1.2rem; margin: 20px 0 5px 0; text-align: center; color: white; }
        .stats { font-family: monospace; font-size: 0.8rem; color: #8b949e; margin-bottom: 10px; text-align: center; }

        /* --- SCROLL WRAPPER --- */
        .chart-wrapper {
            width: 100%;
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 10px;
            display: block; 
        }

        .chart-svg-container {
            display: inline-block; 
            padding-left: 10px; 
            padding-right: 20px; 
        }

        /* --- LEGEND STYLES --- */
        .legend { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 15px; 
            padding: 15px; 
            background: #0d1117; 
            position: fixed; 
            bottom: 0; 
            left: 0;
            border-top: 1px solid #30363d; 
            width: 100%; 
            box-sizing: border-box; 
            z-index: 100;
        }
        .legend-item { display: flex; align-items: center; font-size: 0.8rem; color: #c9d1d9; }
        .legend-box { width: 14px; height: 14px; margin-right: 6px; border-radius: 3px; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:white; margin-top:0;">Login</h2>
            <input type="password" id="password-input" placeholder="Enter Password">
            <button onclick="attemptUnlock()">Enter</button>
            <div id="error-msg" class="error-msg">Wrong Password</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-content">
        <div id="years-container" style="width:100%"></div>

        <!-- UPDATED LEGEND -->
        <div class="legend">
            <div class="legend-item"><div class="legend-box" style="background:#00e676"></div>Clean</div>
            <div class="legend-item"><div class="legend-box" style="background:#2f81f7"></div>Mindful</div>
            <div class="legend-item"><div class="legend-box" style="background:#ffbb00"></div>Visual</div>
            <div class="legend-item"><div class="legend-box" style="background:#c43737"></div>Relapse</div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        // PASTE YOUR GENERATED CODE HERE:
        const ENCRYPTED_URL = "U2FsdGVkX1+rszJFjBAFJPYF14PkiKf03rpTHD7KIxxrtnnEAkk7YaJYJfVpz0wcFuA3aIspysOFNn1VxtKHckzi5tXO7CSTjJu8qlQAvFs0R+Hex4Bi3qcs0Q+wsScpc/tD5sCFw8cmx/tc3JUzd2brkBrQLpRUg/Z4lMfTmSFkBb0dXPWpAOVZDmKeamvM0dld60ylufx1tzyse57OMhOBz7ebabd+QrGR16veiLFgASLn79ICGKmhHoiVbALFhvON+l7Z1mCs/BaDd/mFnQ=="; 

        // ==========================================

        // New Priorities: Relapse > Visual > Mindful.
        // Scores are used for coloring logic.
        const SCORES = {
            RELAPSE: -5,
            VISUAL: -3,
            MINDFUL: -1,
            CLEAN: 1.0
        };

        const COLORS = {
            clean: '#00e676', 
            mindful: '#2f81f7', 
            visual: '#ffbb00',
            relapse: '#c43737', 
            empty: '#161b22'
        };

        function attemptUnlock() {
            const password = document.getElementById('password-input').value;
            const errorMsg = document.getElementById('error-msg');
            try {
                const bytes = CryptoJS.AES.decrypt(ENCRYPTED_URL, password);
                const decryptedURL = bytes.toString(CryptoJS.enc.Utf8);

                if (decryptedURL && decryptedURL.startsWith("http")) {
                    localStorage.setItem('tracker_pass', password);
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-content').style.display = 'flex';
                    init(decryptedURL);
                } else { throw new Error("Invalid"); }
            } catch (e) {
                errorMsg.style.display = 'block';
                errorMsg.innerText = "Wrong Password";
            }
        }

        window.onload = function() {
            const savedPass = localStorage.getItem('tracker_pass');
            if (savedPass) { document.getElementById('password-input').value = savedPass; }
        }

        async function init(url) {
            try {
                const data = await d3.csv(url);
                const processed = processData(data);
                renderAllYears(processed);
            } catch (error) {
                alert("Error loading data: " + error.message);
            }
        }

        function processData(data) {
            const dailyStats = new Map();
            let firstLogDate = null;
            
            const parseDate = d3.timeParse("%m/%d/%Y %H:%M:%S");
            const parseDateShort = d3.timeParse("%m/%d/%Y");

            data.forEach(row => {
                const timestampStr = row['Timestamp'];
                const categoryRaw = row['Column 1'];
                if (!timestampStr || !categoryRaw) return;

                let dateObj = parseDate(timestampStr) || parseDateShort(timestampStr); 
                
                if (dateObj) {
                    const dateKey = d3.timeFormat("%Y-%m-%d")(dateObj);
                    if (!firstLogDate || dateObj < firstLogDate) firstLogDate = dateObj;

                    if (!dailyStats.has(dateKey)) {
                        // Initialize counters for this day
                        dailyStats.set(dateKey, { 
                            relapseCount: 0, 
                            hasVisual: false, 
                            hasMindful: false 
                        });
                    }

                    const stat = dailyStats.get(dateKey);
                    const cat = categoryRaw.trim();

                    // --- NEW PRECEDENCE LOGIC ---
                    if (cat.includes('Relapse')) {
                        stat.relapseCount += 1;
                    } else if (cat.includes('Visual')) {
                        stat.hasVisual = true;
                    } else if (cat.includes('Mindful')) {
                        stat.hasMindful = true;
                    }
                    // Stimulus and Fantasy are ignored
                }
            });

            // Post-process: Calculate Final Score based on Precedence
            // Relapse > Visual > Mindful
            dailyStats.forEach((value, key) => {
                if (value.relapseCount > 0) {
                    value.finalScore = SCORES.RELAPSE;
                } else if (value.hasVisual) {
                    value.finalScore = SCORES.VISUAL;
                } else if (value.hasMindful) {
                    value.finalScore = SCORES.MINDFUL;
                } else {
                    // Should technically be clean, but this case usually implies ignored data (like only Fantasy)
                    value.finalScore = SCORES.CLEAN; 
                }
            });

            return { map: dailyStats, startLogDate: firstLogDate };
        }

        function renderAllYears({ map, startLogDate }) {
            const container = document.getElementById('years-container');
            container.innerHTML = ""; 

            const currentYear = new Date().getFullYear();
            const startYear = startLogDate ? startLogDate.getFullYear() : currentYear;

            // Loop backwards from Current Year down to Start Year
            for (let y = currentYear; y >= startYear; y--) {
                const yearBlock = document.createElement('div');
                yearBlock.className = 'year-block';
                
                const title = document.createElement('h1');
                title.innerText = `${y} PROTOCOL VIEW`;
                yearBlock.appendChild(title);

                const stats = document.createElement('div');
                stats.className = 'stats';
                stats.id = `stats-${y}`;
                yearBlock.appendChild(stats);

                const wrapper = document.createElement('div');
                wrapper.className = 'chart-wrapper';
                wrapper.id = `wrapper-${y}`;

                const svgContainer = document.createElement('div');
                svgContainer.className = 'chart-svg-container';
                svgContainer.id = `chart-${y}`;

                wrapper.appendChild(svgContainer);
                yearBlock.appendChild(wrapper);
                container.appendChild(yearBlock);

                renderSingleYear(y, map, startLogDate);
            }
        }

        function renderSingleYear(targetYear, map, globalStartLogDate) {
            const now = new Date();
            const startDate = new Date(targetYear, 0, 1);
            const endDate = new Date(targetYear, 11, 31);
            const allDays = d3.timeDays(startDate, endDate);
            
            const cellSize = 14; 
            const cellGap = 3;
            const weekLabelWidth = 30;
            const height = (cellSize + cellGap) * 7 + 30; 
            const width = (cellSize + cellGap) * 54 + weekLabelWidth; 

            const svg = d3.select(`#chart-${targetYear}`).append("svg")
                .attr("width", width)
                .attr("height", height)
                .style("font-family", "monospace");

            const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
            svg.selectAll(".dayLabel")
                .data(days)
                .enter().append("text")
                .text(d => d)
                .attr("x", 0)
                .attr("y", (d, i) => i * (cellSize + cellGap) + (cellSize / 1.3)) 
                .style("text-anchor", "start")
                .style("fill", "#8b949e")
                .style("font-size", "9px");

            const g = svg.append("g").attr("transform", `translate(${weekLabelWidth}, 0)`);

            let cleanDaysCount = 0; 
            let relapseDaysCount = 0; 
            let totalActiveDays = 0;

            g.selectAll("rect").data(allDays).enter().append("rect")
                .attr("width", cellSize).attr("height", cellSize)
                .attr("x", d => d3.timeMonday.count(d3.timeYear(d), d) * (cellSize + cellGap))
                .attr("y", d => {
                    const dayIndex = d.getDay(); 
                    const rowIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                    return rowIndex * (cellSize + cellGap);
                })
                .attr("rx", 2).attr("ry", 2)
                .attr("fill", d => {
                    const dateKey = d3.timeFormat("%Y-%m-%d")(d);
                    const isFuture = d > now;
                    const isActive = d >= globalStartLogDate && d <= now;

                    if (isFuture) return COLORS.empty;

                    let score = SCORES.CLEAN; 
                    if (map.has(dateKey)) {
                        score = map.get(dateKey).finalScore;
                    } else if (!isActive) {
                        return COLORS.empty; 
                    }

                    if (isActive) {
                        totalActiveDays++;
                        if (score === SCORES.CLEAN) cleanDaysCount++;
                        if (score === SCORES.RELAPSE) relapseDaysCount++;
                    }

                    // --- COLOR LOGIC ---
                    if (score === SCORES.RELAPSE) return COLORS.relapse;
                    if (score === SCORES.VISUAL) return COLORS.visual;
                    if (score === SCORES.MINDFUL) return COLORS.mindful;
                    return COLORS.clean;
                })
                .on("click", (event, d) => {
                    const dateKey = d3.timeFormat("%Y-%m-%d")(d);
                    const data = map.get(dateKey);
                    
                    let status = "Clean";
                    if (data) {
                        if (data.finalScore === SCORES.RELAPSE) status = `Relapse (${data.relapseCount}x)`;
                        else if (data.finalScore === SCORES.VISUAL) status = "Visual";
                        else if (data.finalScore === SCORES.MINDFUL) status = "Mindful";
                    }
                    alert(`${dateKey}\nStatus: ${status}`);
                });

            // --- COUNT LABELS (Only for Relapse > 1) ---
            g.selectAll(".countLabel").data(allDays).enter().append("text")
                .text(d => {
                    const dateKey = d3.timeFormat("%Y-%m-%d")(d);
                    if (map.has(dateKey)) {
                        const data = map.get(dateKey);
                        // Only show number if it is a Relapse day AND count > 1
                        if (data.finalScore === SCORES.RELAPSE && data.relapseCount > 1) {
                            return data.relapseCount;
                        }
                    }
                    return "";
                })
                .attr("x", d => d3.timeMonday.count(d3.timeYear(d), d) * (cellSize + cellGap) + cellSize/2)
                .attr("y", d => {
                    const dayIndex = d.getDay(); 
                    const rowIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                    return rowIndex * (cellSize + cellGap) + cellSize/1.3;
                })
                .style("text-anchor", "middle")
                .style("fill", "white")
                .style("font-size", "9px")
                .style("font-weight", "bold")
                .style("pointer-events", "none");

            // Update Stats
            document.getElementById(`stats-${targetYear}`).innerText = `Clean: ${cleanDaysCount}/${totalActiveDays} | Relapse: ${relapseDaysCount}`;
            
            // Auto Scroll
            const wrapper = document.getElementById(`wrapper-${targetYear}`);
            wrapper.scrollLeft = wrapper.scrollWidth;
        }
    </script>
</body>
</html>
